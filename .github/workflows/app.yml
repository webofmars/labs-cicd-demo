name: build

on: [push]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install modules
      run: yarn install --dev
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    - name: Build Assets
      run: |
        yarn encore dev
        yarn encore production
    - name: Create artifact
      run: tar -zcvf artifact.tar.gz assets bin node_modules public var vendor
    - name: Upload artifact
      uses: actions/upload-artifact@v1
      with:
        name: artifact
        path: artifact.tar.gz

  tests:
    env:
      DATABASE_URL: "mysql://root:root@127.0.0.1:3306/app?serverVersion=5.7"
    # NB: Github actions already have a running mysql service
    # services:
    #   mysql:
    #     image: mysql:5.7
    #     ports:
    #     - 3306:3306
    #     env:
    #       MYSQL_ROOT_PASSWORD: "root"
    #       MYSQL_USER: tests
    #       MYSQL_PASSWORD: tests
    #       MYSQL_DATABASE: app
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v1
      with:
        name: artifact
    - name: Restore artifact
      run: tar -zxvf artifact/artifact.tar.gz && rm artifact/artifact.tar.gz
    - name: Unit tests
      run: php bin/phpunit ./tests/unit-tests
    - name: Functional tests
      run: php bin/phpunit ./tests/functionnal-tests

  deploy_stg:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v1
      with:
        name: artifact
    - name: Restore artifact
      run: tar -zxvf artifact/artifact.tar.gz && rm artifact/artifact.tar.gz
    - name: copy file via ssh
      uses: appleboy/scp-action@master
      with:
        host: apdemo-stg.wmars.space
        username: ${{ secrets.SSH_REMOTE_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "."
        target: "/srv/staging/"
